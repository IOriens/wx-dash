<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>客服消息</title>
  <link rel="stylesheet" href="../../style.css" />
  <link rel="stylesheet" href="../../website.css" />
  <style type="text/css">
    body {
      padding: 1em;
    }
  </style>
</head>
<body>
  
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="接收消息和事件">接收消息和事件</h2>
<p>在页面中使用 <a href="../../component/button.html"><code><button open-type="contact" /></code></a> 可以显示进入客服会话按钮。</p>
<p>当用户在客服会话发送消息（或进行某些特定的用户操作引发的事件推送时），微信服务器会将消息（或事件）的数据包（JSON或者XML格式）POST请求开发者填写的URL。开发者收到请求后可以使用<a href="conversation.html#发送客服消息">发送客服消息</a>接口进行异步回复。</p>
<p>微信服务器在将用户的消息发给小程序的开发者服务器地址（开发设置处配置）后，微信服务器在五秒内收不到响应会断掉连接，并且重新发起请求，总共重试三次，如果在调试中，发现用户无法收到响应的消息，可以检查是否消息处理超时。关于重试的消息排重，有msgid的消息推荐使用msgid排重。事件类型消息推荐使用FromUserName + CreateTime 排重。</p>
<p>服务器收到请求必须做出下述回复，这样微信服务器才不会对此作任何处理，并且不会发起重试，否则，将出现严重的错误提示。详见下面说明：</p>
<pre><code>1、直接回复success（推荐方式）
2、直接回复空串（指字节长度为0的空字符串，而不是结构体中content字段的内容为空）
</code></pre><p>一旦遇到以下情况，微信都会在小程序会话中，向用户下发系统提示“该小程序客服暂时无法提供服务，请稍后再试”：</p>
<pre><code>1、开发者在5秒内未回复任何内容
2、开发者回复了异常数据
</code></pre><p>如果开发者希望增强安全性，可以在开发者中心处开启消息加密，这样，用户发给小程序的消息以及小程序被动回复用户消息都会继续加密，详见<a href="https://open.weixin.qq.com/cgi-bin/showdocument?action=dir_list&t=resource/res_list&verify=1&id=open1419318479&token=&lang=zh_CN" target="_blank">消息加解密说明</a>。</p>
<p>各消息类型的推送JSON、XML数据包结构如下。</p>
<h3 id="文本消息">文本消息</h3>
<p>用户在客服会话中发送文本消息时将产生如下数据包：</p>
<h4 id="xml-格式">XML 格式</h4>
<pre><code class="lang-xml"><span class="hljs-tag"><<span class="hljs-name">xml</span>></span>
   <span class="hljs-tag"><<span class="hljs-name">ToUserName</span>></span><![CDATA[toUser]]><span class="hljs-tag"></<span class="hljs-name">ToUserName</span>></span>
   <span class="hljs-tag"><<span class="hljs-name">FromUserName</span>></span><![CDATA[fromUser]]><span class="hljs-tag"></<span class="hljs-name">FromUserName</span>></span>
   <span class="hljs-tag"><<span class="hljs-name">CreateTime</span>></span>1482048670<span class="hljs-tag"></<span class="hljs-name">CreateTime</span>></span>
   <span class="hljs-tag"><<span class="hljs-name">MsgType</span>></span><![CDATA[text]]><span class="hljs-tag"></<span class="hljs-name">MsgType</span>></span>
   <span class="hljs-tag"><<span class="hljs-name">Content</span>></span><![CDATA[this is a test]]><span class="hljs-tag"></<span class="hljs-name">Content</span>></span>
   <span class="hljs-tag"><<span class="hljs-name">MsgId</span>></span>1234567890123456<span class="hljs-tag"></<span class="hljs-name">MsgId</span>></span>
<span class="hljs-tag"></<span class="hljs-name">xml</span>></span>
</code></pre>
<h4 id="json--格式">JSON  格式</h4>
<pre><code class="lang-json">{
    <span class="hljs-string">"ToUserName"</span>: <span class="hljs-string">"toUser"</span>,
    <span class="hljs-string">"FromUserName"</span>: <span class="hljs-string">"fromUser"</span>,
    <span class="hljs-string">"CreateTime"</span>: <span class="hljs-number">1482048670</span>,
    <span class="hljs-string">"MsgType"</span>: <span class="hljs-string">"text"</span>,
    <span class="hljs-string">"Content"</span>: <span class="hljs-string">"this is a test"</span>,
    <span class="hljs-string">"MsgId"</span>: <span class="hljs-number">1234567890123456</span>
}
</code></pre>
<h4 id="参数说明">参数说明</h4>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ToUserName</td>
<td>小程序的原始ID</td>
</tr>
<tr>
<td style="text-align:left">FromUserName</td>
<td>发送者的openid</td>
</tr>
<tr>
<td style="text-align:left">CreateTime</td>
<td>消息创建时间(整型）</td>
</tr>
<tr>
<td style="text-align:left">MsgType</td>
<td>text</td>
</tr>
<tr>
<td style="text-align:left">Content</td>
<td>文本消息内容</td>
</tr>
<tr>
<td style="text-align:left">MsgId</td>
<td>消息id，64位整型</td>
</tr>
</tbody>
</table>
<h3 id="图片消息">图片消息</h3>
<p>用户在客服会话中发送图片消息时将产生如下数据包：</p>
<h4 id="xml-格式">XML 格式</h4>
<pre><code class="lang-xml"><span class="hljs-tag"><<span class="hljs-name">xml</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">ToUserName</span>></span><![CDATA[toUser]]><span class="hljs-tag"></<span class="hljs-name">ToUserName</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">FromUserName</span>></span><![CDATA[fromUser]]><span class="hljs-tag"></<span class="hljs-name">FromUserName</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">CreateTime</span>></span>1482048670<span class="hljs-tag"></<span class="hljs-name">CreateTime</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">MsgType</span>></span><![CDATA[image]]><span class="hljs-tag"></<span class="hljs-name">MsgType</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">PicUrl</span>></span><![CDATA[this is a url]]><span class="hljs-tag"></<span class="hljs-name">PicUrl</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">MediaId</span>></span><![CDATA[media_id]]><span class="hljs-tag"></<span class="hljs-name">MediaId</span>></span>
      <span class="hljs-tag"><<span class="hljs-name">MsgId</span>></span>1234567890123456<span class="hljs-tag"></<span class="hljs-name">MsgId</span>></span>
<span class="hljs-tag"></<span class="hljs-name">xml</span>></span>
</code></pre>
<h4 id="json--格式">JSON  格式</h4>
<pre><code class="lang-json">{
    <span class="hljs-string">"ToUserName"</span>: <span class="hljs-string">"toUser"</span>,
    <span class="hljs-string">"FromUserName"</span>: <span class="hljs-string">"fromUser"</span>,
    <span class="hljs-string">"CreateTime"</span>: <span class="hljs-number">1482048670</span>,
    <span class="hljs-string">"MsgType"</span>: <span class="hljs-string">"image"</span>,
    <span class="hljs-string">"PicUrl"</span>: <span class="hljs-string">"this is a url"</span>,
    <span class="hljs-string">"MediaId"</span>: <span class="hljs-string">"media_id"</span>,
    <span class="hljs-string">"MsgId"</span>: <span class="hljs-number">1234567890123456</span>
}
</code></pre>
<h4 id="参数说明">参数说明</h4>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ToUserName</td>
<td>小程序的原始ID</td>
</tr>
<tr>
<td style="text-align:left">FromUserName</td>
<td>发送者的openid</td>
</tr>
<tr>
<td style="text-align:left">CreateTime</td>
<td>消息创建时间(整型）</td>
</tr>
<tr>
<td style="text-align:left">MsgType</td>
<td>image</td>
</tr>
<tr>
<td style="text-align:left">PicUrl</td>
<td>图片链接（由系统生成）</td>
</tr>
<tr>
<td style="text-align:left">MediaId</td>
<td>图片消息媒体id，可以调用<a href="material.html#获取临时素材">获取临时素材</a>接口拉取数据。</td>
</tr>
<tr>
<td style="text-align:left">MsgId</td>
<td>消息id，64位整型</td>
</tr>
</tbody>
</table>
<h3 id="小程序卡片消息">小程序卡片消息</h3>
<p>用户在客服会话中发送小程序卡片消息时将产生如下数据包：</p>
<h4 id="xml-格式">XML 格式</h4>
<pre><code class="lang-xml"><span class="hljs-tag"><<span class="hljs-name">xml</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">ToUserName</span>></span><![CDATA[toUser]]><span class="hljs-tag"></<span class="hljs-name">ToUserName</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">FromUserName</span>></span><![CDATA[fromUser]]><span class="hljs-tag"></<span class="hljs-name">FromUserName</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">CreateTime</span>></span>1482048670<span class="hljs-tag"></<span class="hljs-name">CreateTime</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">MsgType</span>></span><![CDATA[miniprogrampage]]><span class="hljs-tag"></<span class="hljs-name">MsgType</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">MsgId</span>></span>1234567890123456<span class="hljs-tag"></<span class="hljs-name">MsgId</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">Title</span>></span><![CDATA[Title]]><span class="hljs-tag"></<span class="hljs-name">Title</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">AppId</span>></span><![CDATA[AppId]]><span class="hljs-tag"></<span class="hljs-name">AppId</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">PagePath</span>></span><![CDATA[PagePath]]><span class="hljs-tag"></<span class="hljs-name">PagePath</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">ThumbUrl</span>></span><![CDATA[ThumbUrl]]><span class="hljs-tag"></<span class="hljs-name">ThumbUrl</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">ThumbMediaId</span>></span><![CDATA[ThumbMediaId]]><span class="hljs-tag"></<span class="hljs-name">ThumbMediaId</span>></span>
<span class="hljs-tag"></<span class="hljs-name">xml</span>></span>
</code></pre>
<h4 id="json--格式">JSON  格式</h4>
<pre><code class="lang-json">{
    <span class="hljs-string">"ToUserName"</span>: <span class="hljs-string">"toUser"</span>,
    <span class="hljs-string">"FromUserName"</span>: <span class="hljs-string">"fromUser"</span>,
    <span class="hljs-string">"CreateTime"</span>: <span class="hljs-number">1482048670</span>,
    <span class="hljs-string">"MsgType"</span>: <span class="hljs-string">"miniprogrampage"</span>,
    <span class="hljs-string">"MsgId"</span>: <span class="hljs-number">1234567890123456</span>,
    <span class="hljs-string">"Title"</span>:<span class="hljs-string">"title"</span>,
    <span class="hljs-string">"AppId"</span>:<span class="hljs-string">"appid"</span>,
    <span class="hljs-string">"PagePath"</span>:<span class="hljs-string">"path"</span>,
    <span class="hljs-string">"ThumbUrl"</span>:<span class="hljs-string">""</span>,
    <span class="hljs-string">"ThumbMediaId"</span>:<span class="hljs-string">""</span>
}
</code></pre>
<h4 id="参数说明">参数说明</h4>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ToUserName</td>
<td>小程序的原始ID</td>
</tr>
<tr>
<td>FromUserName</td>
<td>发送者的openid</td>
</tr>
<tr>
<td>CreateTime</td>
<td>消息创建时间(整型）</td>
</tr>
<tr>
<td>MsgType</td>
<td>miniprogrampage</td>
</tr>
<tr>
<td>MsgId</td>
<td>消息id，64位整型</td>
</tr>
<tr>
<td>Title</td>
<td>标题</td>
</tr>
<tr>
<td>AppId</td>
<td>小程序appid</td>
</tr>
<tr>
<td>PagePath</td>
<td>小程序页面路径</td>
</tr>
<tr>
<td>ThumbUrl</td>
<td>封面图片的临时cdn链接</td>
</tr>
<tr>
<td>ThumbMediaId</td>
<td>封面图片的临时素材id</td>
</tr>
</tbody>
</table>
<h3 id="进入会话事件">进入会话事件</h3>
<p>用户在小程序“客服会话按钮”进入客服会话时将产生如下数据包：</p>
<h4 id="xml-格式">XML 格式</h4>
<pre><code class="lang-xml"><span class="hljs-tag"><<span class="hljs-name">xml</span>></span>
    <span class="hljs-tag"><<span class="hljs-name">ToUserName</span>></span><![CDATA[toUser]]><span class="hljs-tag"></<span class="hljs-name">ToUserName</span>></span>  
    <span class="hljs-tag"><<span class="hljs-name">FromUserName</span>></span><![CDATA[fromUser]]><span class="hljs-tag"></<span class="hljs-name">FromUserName</span>></span>  
    <span class="hljs-tag"><<span class="hljs-name">CreateTime</span>></span>1482048670<span class="hljs-tag"></<span class="hljs-name">CreateTime</span>></span>  
    <span class="hljs-tag"><<span class="hljs-name">MsgType</span>></span><![CDATA[event]]><span class="hljs-tag"></<span class="hljs-name">MsgType</span>></span>  
    <span class="hljs-tag"><<span class="hljs-name">Event</span>></span><![CDATA[user_enter_tempsession]]><span class="hljs-tag"></<span class="hljs-name">Event</span>></span>  
    <span class="hljs-tag"><<span class="hljs-name">SessionFrom</span>></span><![CDATA[sessionFrom]]><span class="hljs-tag"></<span class="hljs-name">SessionFrom</span>></span> 
<span class="hljs-tag"></<span class="hljs-name">xml</span>></span>
</code></pre>
<h4 id="json-格式">JSON 格式</h4>
<pre><code class="lang-json">{
    <span class="hljs-string">"ToUserName"</span>: <span class="hljs-string">"toUser"</span>,
    <span class="hljs-string">"FromUserName"</span>: <span class="hljs-string">"fromUser"</span>,
    <span class="hljs-string">"CreateTime"</span>: <span class="hljs-number">1482048670</span>,
    <span class="hljs-string">"MsgType"</span>: <span class="hljs-string">"event"</span>,
    <span class="hljs-string">"Event"</span>: <span class="hljs-string">"user_enter_tempsession"</span>,
    <span class="hljs-string">"SessionFrom"</span>: <span class="hljs-string">"sessionFrom"</span>
}
</code></pre>
<h4 id="参数说明">参数说明</h4>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ToUserName</td>
<td>小程序的原始ID</td>
</tr>
<tr>
<td style="text-align:left">FromUserName</td>
<td>发送者的openid</td>
</tr>
<tr>
<td style="text-align:left">CreateTime</td>
<td>事件创建时间(整型）</td>
</tr>
<tr>
<td style="text-align:left">MsgType</td>
<td>event</td>
</tr>
<tr>
<td style="text-align:left">Event</td>
<td>事件类型，user_enter_tempsession</td>
</tr>
<tr>
<td style="text-align:left">SessionFrom</td>
<td>开发者在<a href="../../component/button.html">客服会话按钮</a>设置的session-from属性</td>
</tr>
</tbody>
</table>

                                
                                </section>
                            
    </div>
    
</div>

                        
</body>
</html>
