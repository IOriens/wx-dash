<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>开发插件</title>
  <link rel="stylesheet" href="../../style.css" />
  <link rel="stylesheet" href="../../website.css" />
  <style type="text/css">
    body {
      padding: 1em;
    }
  </style>
</head>
<body>
  
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="开发插件">开发插件</h1>
<p>开发插件前，请阅读了解<a href="../../../introduction/plugin.html">《小程序插件接入指南》</a>了解开通流程及开放范围，并开通插件功能。如果未开通插件功能，将无法上传插件。</p>
<h2 id="创建插件项目">创建插件项目</h2>
<p>插件类型的项目可以在开发者工具中直接创建。<a href="../../devtools/plugin.html">详情</a></p>
<p><img src="https://mp.weixin.qq.com/debug/wxadoc/dev/image/devtools2/createplugin.png?t=2018413" alt="创建插件"></p>
<p>新建插件类型的项目后，如果创建示例项目，则项目中将包含两个目录：</p>
<ul>
<li><code>plugin</code> 目录：插件代码目录。</li>
<li><code>miniprogram</code> 目录：放置一个小程序，用于调试插件。</li>
</ul>
<p>后者可以当成普通小程序来编写，用于插件调试、预览和审核。下面的内容主要介绍前者的编写方法。</p>
<h2 id="插件目录结构">插件目录结构</h2>
<p>一个插件可以包含若干个自定义组件，和一组js接口。插件的目录内容如下：</p>
<pre><code>├── components
│   ├── hello-component.js   // 插件提供的自定义组件（可以有多个）
│   ├── hello-component.json
│   ├── hello-component.wxml
│   └── hello-component.wxss
├── index.js                 // 插件的 js 接口
└── plugin.json              // 插件配置文件
</code></pre><h2 id="插件配置文件">插件配置文件</h2>
<p>插件配置文件 <code>plugin.json</code> 主要说明有哪些自定义组件可以供插件外部调用，并标识哪个js文件是插件的js接口文件，如：</p>
<p><strong>代码示例：</strong></p>
<pre><code class="lang-json">{
  <span class="hljs-string">"publicComponents"</span>: {
    <span class="hljs-string">"hello-component"</span>: <span class="hljs-string">"components/hello-component"</span>
  },
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"index.js"</span>
}
</code></pre>
<h2 id="插件对外接口">插件对外接口</h2>
<p>插件内的自定义组件与普通的自定义组件相仿。插件可以定义若干个自定义组件，这些自定义组件都可以在插件内相互引用。其中，提供给外部使用的自定义组件，必须在插件配置文件中显式声明。</p>
<p>插件的 js 接口文件 <code>index.js</code> 中可以 export 一些 js 接口，插件的使用者可以使用 <code>requirePlugin</code> 来获得这些接口。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="lang-js"><span class="hljs-built_in">module</span>.exports = {
  hello: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Hello plugin!'</span>)
  }
}
</code></pre>
<h2 id="上传和发布">上传和发布</h2>
<p>插件可以像小程序一样预览和上传，但插件没有体验版。</p>
<p>插件会同时有多个线上版本，由使用插件的小程序决定具体使用的版本号。</p>
<h2 id="插件请求签名">插件请求签名</h2>
<p>插件在使用 <code>wx.request</code> 等 API 发送网络请求时，将会额外携带一个签名 <code>HostSign</code> ，用于验证请求来源于小程序插件。这个签名位于请求头中，形如：</p>
<pre><code class="lang-js">X-WECHAT-HOSTSIGN: {<span class="hljs-string">"noncestr"</span>:<span class="hljs-string">"NONCESTR"</span>, <span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"TIMESTAMP"</span>, <span class="hljs-string">"signature"</span>:<span class="hljs-string">"SIGNATURE"</span>}
</code></pre>
<p>其中， <code>NONCESTR</code> 和 <code>TIMESTAMP</code> 是是用于计算签名 <code>SIGNATRUE</code> 的参数，签名算法为：</p>
<pre><code class="lang-js">SIGNATURE = sha1(APPID + NONCESTR + TIMESTAMP + TOKEN)
</code></pre>
<p>插件开发者可以在服务器上使用这个算法校验签名。其中， <code>APPID</code> 是所在小程序的 AppId ； <code>TOKEN</code> 是插件 Token ，可以在小程序插件基本设置中找到。</p>
<p><strong>Tips:</strong></p>
<ul>
<li>目前，手机预览插件时将使用一个特殊分配的小程序 appid （与插件的 appid 不同）。</li>
</ul>

                                
                                </section>
                            
    </div>
    
</div>

                        
</body>
</html>
