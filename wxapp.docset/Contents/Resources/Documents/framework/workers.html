<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>多线程</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../website.css" />
  <style type="text/css">
    body {
      padding: 1em;
    }
  </style>
</head>
<body>
  
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="多线程-worker">多线程 Worker</h2>
<p>一些异步处理的任务，可以放置于 Worker 中运行，待运行结束后，再把结果返回到小程序主线程。Worker 运行于一个单独的全局上下文与线程中，不能直接调用主线程的方法。
Worker 与主线程之间的数据传输，双方使用 <a href="../api/createWorker.html">Worker.postMessage()</a> 来发送数据，<a href="../api/createWorker.html">Worker.onMessage()</a> 来接收数据，传输的数据并不是直接共享，而是被复制的。</p>
<h4 id="步骤">步骤</h4>
<h5 id="1-配置-worker-信息">1. 配置 Worker 信息</h5>
<p>在 <code>app.json</code> 中可配置 <code>Worker</code> 代码放置的目录，目录下的代码将被打包成一个文件：</p>
<p>配置示例：</p>
<pre><code class="lang-json">{
  <span class="hljs-string">"workers"</span>: <span class="hljs-string">"workers"</span>
}
</code></pre>
<h5 id="2-添加-worker-代码文件">2. 添加 Worker 代码文件</h5>
<p>根据步骤 1 中的配置，在代码目录下新建以下两个入口文件：</p>
<pre><code>workers/request/index.js
workers/request/utils.js
workers/response/index.js
</code></pre><p>添加后，目录结构如下：</p>
<pre><code>├── app.js
├── app.json
├── project.config.json
└── workers
    ├── request
    │   ├── index.js
    │   └── utils.js
    └── response
        └── index.js
</code></pre><h4 id="3-编写-worker-代码">3. 编写 Worker 代码</h4>
<p>在 <code>workers/request/index.js</code> 编写 Worker 响应代码</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./utils'</span>)

<span class="hljs-comment">// 在 Worker 线程执行上下文会全局暴露一个 `worker` 对象，直接调用 worker.onMeesage/postMessage 即可</span>
worker.onMessage(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">res</span>) </span>{
  <span class="hljs-built_in">console</span>.log(res)
})
</code></pre>
<h4 id="4-在主线程中初始化-worker">4. 在主线程中初始化 Worker</h4>
<p>在主线程的代码 app.js 中初始化 Worker</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> worker = wx.createWorker(<span class="hljs-string">'workers/request/index.js'</span>) <span class="hljs-comment">// 文件名指定 worker 的入口文件路径，绝对路径</span>
</code></pre>
<h4 id="5-主线程向-worker-发送消息">5. 主线程向 Worker 发送消息</h4>
<pre><code class="lang-javascript">worker.postMessage({
  msg: <span class="hljs-string">'hello worker'</span>
})
</code></pre>
<p>worker 对象的其它接口请看 <a href="../api/createWorker.html">worker接口说明</a></p>
<h4 id="tips">Tips</h4>
<ol>
<li>Worker 最大并发数量限制为 1 个，创建下一个前请用 <a href="../api/createWorker.html">Worker.terminate()</a> 结束当前 Worker</li>
<li>Worker 内代码只能 require 指定 Worker 路径内的文件，无法引用其它路径</li>
<li>Worker 的入口文件由 <a href="../api/createWorker.html">wx.createWorker()</a> 时指定，开发者可动态指定 Worker 入口文件</li>
<li>Worker 内不支持 <code>wx</code> 系列的 API</li>
<li>Workers 之间不支持发送消息</li>
</ol>

                                
                                </section>
                            
    </div>
    
</div>

                        
</body>
</html>
