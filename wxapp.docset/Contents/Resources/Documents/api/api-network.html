<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>网络</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="../website.css" />
  <style type="text/css">
    body {
      padding: 1em;
    }
  </style>
</head>
<body>
  
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="关于小程序中网络相关api的说明">关于小程序中网络相关API的说明</h1>
<p><strong>网络API列表：</strong></p>
<table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="network-request.html">wx.request</a></td>
<td>发起网络请求</td>
</tr>
<tr>
<td><a href="network-file.html#wxuploadfileobject">wx.uploadFile</a></td>
<td>上传文件</td>
</tr>
<tr>
<td><a href="network-file.html#wxdownloadfileobject">wx.downloadFile</a></td>
<td>下载文件</td>
</tr>
<tr>
<td><a href="network-socket.html#wxconnectsocketobject">wx.connectSocket</a></td>
<td>创建 WebSocket 连接</td>
</tr>
<tr>
<td><a href="network-socket.html#wxonsocketopencallback">wx.onSocketOpen</a></td>
<td>监听 WebSocket 打开</td>
</tr>
<tr>
<td><a href="network-socket.html#wxonsocketerrorcallback">wx.onSocketError</a></td>
<td>监听 WebSocket 错误</td>
</tr>
<tr>
<td><a href="network-socket.html#wxsendsocketmessageobject">wx.sendSocketMessage</a></td>
<td>发送 WebSocket 消息</td>
</tr>
<tr>
<td><a href="network-socket.html#wxonsocketmessagecallback">wx.onSocketMessage</a></td>
<td>接受 WebSocket 消息</td>
</tr>
<tr>
<td><a href="network-socket.html#wxclosesocket">wx.closeSocket</a></td>
<td>关闭 WebSocket 连接</td>
</tr>
<tr>
<td><a href="network-socket.html#wxonsocketclosecallback">wx.onSocketClose</a></td>
<td>监听 WebSocket 关闭</td>
</tr>
</tbody>
</table>
<p>在小程序中使用网络相关的 API 时，需要注意下列问题，请开发者提前了解。</p>
<h2 id="1-服务器域名配置">1. 服务器域名配置</h2>
<p>每个微信小程序需要事先设置一个通讯域名，小程序可以跟指定的域名与进行网络通信。包括普通 HTTPS 请求（<code>request</code>）、上传文件（<code>uploadFile</code>）、下载文件（<code>downloadFile</code>) 和 WebSocket 通信（<code>connectSocket</code>）</p>
<h3 id="配置流程">配置流程</h3>
<p>服务器域名请在 <code>小程序后台-设置-开发设置-服务器域名</code> 中进行配置，配置时需要注意：</p>
<ul>
<li>域名只支持 <code>https</code> (<code>request</code>、<code>uploadFile</code>、<code>downloadFile</code>) 和 <code>wss</code> (<code>connectSocket</code>) 协议；</li>
<li>域名不能使用 IP 地址或 localhost，且不能带端口号；</li>
<li>域名必须经过 ICP 备案；</li>
<li><strong>出于安全考虑，<code>api.weixin.qq.com</code> 不能被配置为服务器域名，相关API也不能在小程序内调用。</strong>开发者应将 appsecret 保存到后台服务器中，通过服务器使用 appsecret 获取 accesstoken，并调用相关 API。</li>
<li>对于每个接口，分别可以配置最多 20 个域名</li>
</ul>
<h3 id="https-证书">HTTPS 证书</h3>
<p>小程序必须使用 HTTPS 请求。小程序内会对服务器域名使用的 HTTPS 证书进行校验，如果校验失败，则请求不能成功发起。由于系统限制，不同平台对于证书要求的严格程度不同。为了保证小程序的兼容性，建议开发者按照最高标准进行证书配置，并使用相关工具检查现有证书是否符合要求。</p>
<p>对证书要求如下：</p>
<ul>
<li>HTTPS 证书必须有效。证书必须被系统信任，部署SSL证书的网站域名必须与证书颁发的域名一致，证书必须在有效期内;</li>
<li><code>iOS</code> 不支持自签名证书;</li>
<li><code>iOS</code> 下证书必须满足苹果  <a href="https://developer.apple.com/library/content/documentation/General/Reference/InfoPlistKeyReference/Articles/CocoaKeys.html#//apple_ref/doc/uid/TP40009251-SW33" target="_blank">App Transport Security (ATS)</a> 的要求;</li>
<li>TLS 必须支持 1.2 及以上版本。部分旧 <code>Android</code> 机型还未支持 TLS 1.2，请确保 HTTPS 服务器的 TLS 版本支持1.2及以下版本;</li>
<li>部分 CA 可能不被操作系统信任，请开发者在选择证书时注意小程序和各系统的相关通告。<ul>
<li><a href="http://developers.weixin.qq.com/blogdetail?action=get_post_info&lang=zh_CN&token=&docid=800026caeb042e45681583652b70910a" target="_blank">Chrome 56/57 内核对 WoSign、StartCom 证书限制周知</a></li>
</ul>
</li>
</ul>
<h3 id="跳过域名校验">跳过域名校验</h3>
<p>在微信开发者工具中，可以临时开启 <code>开发环境不校验请求域名、TLS版本及HTTPS证书</code> 选项，跳过服务器域名的校验。此时，在微信开发者工具中及手机开启调试模式时，不会进行服务器域名的校验。</p>
<p><strong>在服务器域名配置成功后，建议开发者关闭此选项进行开发，并在各平台下进行测试，以确认服务器域名配置正确。</strong></p>
<blockquote>
<p>如果手机上出现 “打开调试模式可以发出请求，关闭调试模式无法发出请求” 的现象，请确认是否跳过了域名校验，并确认服务器域名和证书配置是否正确。</p>
</blockquote>
<h2 id="2-关于请求">2. 关于请求</h2>
<ul>
<li>默认超时时间和最大超时时间都是 <strong>60s</strong></li>
<li><code>request</code>、<code>uploadFile</code>、<code>downloadFile</code> 的最大并发限制是 <strong>10</strong> 个</li>
<li>网络请求的 <code>referer</code>  header 不可设置。其格式固定为 <code>https://servicewechat.com/{appid}/{version}/page-frame.html</code>，其中 <code>{appid}</code> 为小程序的 appid，<code>{version}</code> 为小程序的版本号，版本号为 <code>0</code> 表示为开发版、体验版以及审核版本，版本号为 <code>devtools</code> 表示为开发者工具，其余为正式版本。</li>
<li>小程序进入后台运行后（非置顶聊天），如果 <strong>5s</strong> 内网络请求没有结束，会回调错误信息 <code>fail interrupted</code>；在回到前台之前，网络请求接口调用都会无法调用。</li>
</ul>
<h2 id="3-关于服务器返回">3. 关于服务器返回</h2>
<h3 id="返回值编码">返回值编码</h3>
<ul>
<li>建议服务器返回值使用 <strong>UTF-8</strong> 编码。对于非 UTF-8 编码，小程序会尝试进行转换，但是会有转换失败的可能。</li>
<li>小程序会自动对 BOM 头进行过滤。</li>
</ul>
<h3 id="回调">回调</h3>
<ul>
<li><strong>只要成功接收到服务器返回，无论statusCode是多少，都会进入success回调。请开发者根据业务逻辑对返回值进行判断。</strong></li>
</ul>

                                
                                </section>
                            
    </div>
    
</div>

                        
</body>
</html>
